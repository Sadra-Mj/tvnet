<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Iranian TV Channels</title>
  <style>
    body { font-family: sans-serif; padding: 20px; background: #111; color: white; }
    select, video { width: 100%; margin-top: 20px; }
    video { max-width: 800px; height: auto; border: 2px solid #444; }
  </style>
</head>
<body>

  <h1>Choose an Iranian TV Channel</h1>
  <select id="channelList">
    <option>Loading channels...</option>
  </select>

  <video id="tv-player" controls autoplay muted></video>

  <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
  <script>
    const playlistUrl = 'LiveChannels.m3u';
    const select = document.getElementById('channelList');
    const video = document.getElementById('tv-player');

    async function loadChannels() {
      const response = await fetch(playlistUrl);
      const text = await response.text();
      const lines = text.split('\n');

      const groups = {};

      for (let i = 0; i < lines.length; i++) {
        if (lines[i].startsWith('#EXTINF')) {
          const extinf = lines[i];
          const url = lines[i + 1];

          const nameMatch = extinf.match(/,(.*)/);
          const groupMatch = extinf.match(/group-title="(.*?)"/);

          const name = nameMatch ? nameMatch[1] : 'Unknown';
          const group = groupMatch ? groupMatch[1] : 'Other';

          if (url && url.startsWith('http')) {
            if (!groups[group]) groups[group] = [];
            groups[group].push({ name, url });
          }
        }
      }

      // Build <select> with <optgroup>
      let html = '';
      for (const group in groups) {
        html += `<optgroup label="${group}">`;
        html += groups[group].map(ch => 
          `<option value="${ch.url}">${ch.name}</option>`
        ).join('');
        html += `</optgroup>`;
      }

      select.innerHTML = html;

      // Autoplay the first available channel
      const firstGroup = Object.values(groups)[0];
      if (firstGroup && firstGroup.length > 0) {
        playStream(firstGroup[0].url);
      }
    }

    function playStream(streamURL) {
      if (Hls.isSupported()) {
        const hls = new Hls();
        hls.loadSource(streamURL);
        hls.attachMedia(video);
        hls.on(Hls.Events.MANIFEST_PARSED, () => video.play());
      } else if (video.canPlayType('application/vnd.apple.mpegurl')) {
        video.src = streamURL;
        video.addEventListener('loadedmetadata', () => video.play());
      } else {
        alert("Your browser doesn't support HLS.");
      }
    }

    select.addEventListener('change', () => {
      playStream(select.value);
    });

    loadChannels();
  </script>

</body>
</html>
